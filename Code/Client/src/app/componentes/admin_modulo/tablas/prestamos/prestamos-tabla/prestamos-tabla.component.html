<div class="prestamos-container">
  <!-- ESTO ES PARA EL TITULO Y EL BOTON CREAR -->
  <div class="table-header">
    <div class="header-title">
      <h1>Préstamos</h1>
      <p class="subtitle">Gestión de préstamos de equipos de mecatrónica</p>
    </div>   
    <div class="filter-container">
        <button 
          class="btn-filter" 
          (click)="mostrarEstados()"
          (mouseenter)="hover.filter = true"
          (mouseleave)="hover.filter = false"
        >
          <i class="fas fa-filter"></i>
          @if (estadoSeleccionado) {
            <span>{{ estadoSeleccionado }}</span>
          } @else {
            <span>Filtrar</span>
          }
          <i [class]="showEstados ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
        </button>
        
        <!-- Panel flotante que aparece al frente -->
        @if (showEstados) {
          <div class="estados-panel-flotante">
            <div class="estados-grid-flotante">
              <div class="estados-item-flotante" (click)="seleccionarEstado('')" [class.active]="estadoSeleccionado === ''">
                <i class="fas fa-list"></i>
                Todos los estados
              </div>              @for (estado of estadosDisponibles; track estado) {
                <div class="estados-item-flotante" (click)="seleccionarEstado(estado)" [class.active]="estadoSeleccionado === estado">
                  @switch (estado.toLowerCase()) {
                    @case ('pendiente') {
                      <i class="fas fa-clock text-warning"></i>
                    }
                    @case ('aprobado') {
                      <i class="fas fa-check-circle text-success"></i>
                    }
                    @case ('rechazado') {
                      <i class="fas fa-times-circle text-danger"></i>
                    }
                    @case ('activo') {
                      <i class="fas fa-play-circle text-primary"></i>
                    }
                    @case ('finalizado') {
                      <i class="fas fa-check-double text-secondary"></i>
                    }
                    @case ('cancelado') {
                      <i class="fas fa-ban text-danger"></i>
                    }
                    @default {
                      <i class="fas fa-question-circle"></i>
                    }
                  }
                  {{ estado | titlecase }}
                </div>
              }
            </div>
          </div>
        }
      </div> 


  </div>
  <!-- BUSCADOR-->
  <div class="search-container">
    
    <div class="search-and-filter-row">
      <div class="search-input-wrapper">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          [(ngModel)]="terminoBusqueda" 
          (keydown.enter)="aplicarFiltros()"
          placeholder="Buscar préstamos..." 
          class="search-input"
        />
        @if (terminoBusqueda) {
          <button class="clear-search" (click)="limpiarBusqueda()">
            <i class="fas fa-times"></i>
          </button>
        }
      </div>
      
        
    </div>
  </div>

  <!-- TABLA -->
  <div class="table-responsive">
    <table class="data-table">
      <thead>
        <tr>
          <th >
            Usuario 
           
          </th>
          <th >
            Carnet 
          
          </th>
            <th >
                Teléfono
            
            </th>
          <th >
             Equipos
          
          </th>
          
          <th >
            Fecha Solicitud
           
          </th>
          <th >
            Fecha Préstamo Esperada
            
          </th>
            <th >
                Fecha Devolución Esperada
               
            </th>
          <th >
            Estado
         
          </th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (prestamo of (prestamos | keyvalue) ; track prestamo.key){
          <tr>
            <td class="nombre-usuario">
              <span title="{{prestamo.value.datosgrupo.NombreUsuario}} {{prestamo.value.datosgrupo.ApellidoPaternoUsuario}}">
                {{prestamo.value.datosgrupo.NombreUsuario}} {{prestamo.value.datosgrupo.ApellidoPaternoUsuario}}
              </span>
            </td>
            <td>{{prestamo.value.datosgrupo.CarnetUsuario}}</td>
            <td>{{prestamo.value.datosgrupo.TelefonoUsuario}}</td>
            <td class="equipos-cell">
              <div class="equipos-info">
                <span class="nombre-equipo" title="{{prestamo.value.datosgrupo.NombreGrupoEquipo}}">
                  {{prestamo.value.datosgrupo.NombreGrupoEquipo}}
                </span>
                <small class="cantidad-equipos">{{ prestamo?.value?.equipos?.length ?? 0 }} equipos</small>
              </div>
            </td>

            <td>{{prestamo.value.datosgrupo.FechaSolicitud | date:'dd/MM/yyyy'}}</td>
            <td>{{prestamo.value.datosgrupo.FechaPrestamoEsperada | date:'dd/MM/yyyy'}}</td>
            <td>{{prestamo.value.datosgrupo.FechaDevolucionEsperada | date:'dd/MM/yyyy'}}</td>
            <td>
              <span [class]="'estado-' + (getEstadoCalculado(prestamo.value) || '')">
                {{ getEstadoCalculado(prestamo.value) | titlecase }}
              </span>
            </td>
            <td class="actions-column">
           
              <button
                class="btn-icon btn-view"
                title="Ver detalles"
                aria-label="Ver detalles"
                (click)="abrirVistaPrestamos(prestamo.value.equipos)">
                <i class="fas fa-eye"></i>
               </button>

            <button class="btn-icon btn-view" (click)="cambiarestadovercontrato(prestamo.value.datosgrupo)">
                <i class="fas fa-file-contract"></i>
            </button>


            @if(prestamo.value.datosgrupo.EstadoPrestamo == 'rechazado' || prestamo.value.datosgrupo.EstadoPrestamo == 'aprobado' || prestamo.value.datosgrupo.EstadoPrestamo == 'finalizado' || prestamo.value.datosgrupo.EstadoPrestamo == 'cancelado'){
            <button class="btn-icon btn-delete" (click)="eliminarPrestamo(prestamo.value.datosgrupo)">
                <i class="fas fa-trash-alt"></i>
            </button>
            }     
            @else if (prestamo.value.datosgrupo.EstadoPrestamo=='pendiente') {
                <button class="btn-action btn-accept" (click)="validaraprobacion(prestamo.key)">
                  <i class="fas fa-check"></i>
                  Aceptar
                </button>
                <button class="btn-action btn-reject" (click)="validarrechazo(prestamo.key)">
                  <i class="fas fa-times"></i>
                  Rechazar
                </button>
            }
            @else if (prestamo.value.datosgrupo.EstadoPrestamo=='activo') {

            }


            </td>
          </tr>  
        }
        @if (prestamos.size === 0) {
          <tr>
            <td colspan="10" class="empty-table">
              <div class="empty-state">
                <i class="fas fa-search fa-3x"></i>
                <p>No se encontraron préstamos</p>
                <button class="btn btn-outline" (click)="limpiarFiltros()">Limpiar filtros</button>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- ALERTA DE ELIMINACIÓN -->
  @if(alertaeliminar){
    <app-aviso-eliminar
      [mensaje]="'¿Estás seguro de que deseas eliminar este préstamo?'"
      (aceptar)="confirmarEliminacion()"
      (cancelar)="cancelarEliminacion()"
    ></app-aviso-eliminar>


    

  }
</div>


@if(vercontrato()){
  <app-vercontrato
    [vercontraro]="vercontrato"
    [idprestamo]="prestamoSeleccionado.Id"
  ></app-vercontrato>
}


@if (cargando) {
  <app-pantalla-carga> </app-pantalla-carga>
}


@if (abrirVista) {
  <app-vista-prestamos
    [prestamos]="prestamosVista"
    (cerrar)="cerrarVistaPrestamos()"
  ></app-vista-prestamos>
}


@if(error()){
  <app-mostrarerror
  [error]="error"
  [mensaje]="mensajeerror"
  ></app-mostrarerror>
}

@if(exito()){
  <app-aviso-exito
  [exito]="exito"
  [mensaje]="mensajeexito"
  ></app-aviso-exito>
}

@if(aviso()){
  <app-aviso
  [cerrar]="aviso"
  [mensaje]="mensajeaviso"
  (aceptar)="aprobarprestamo(prestamoKeySeleccionado)"
  ></app-aviso>
}


@if(avisorechazar()){
  <app-aviso
  [cerrar]="avisorechazar"
  [mensaje]="mensajeavisorechazar"
  (aceptar)="rechazarprestamo(prestamoKeySeleccionado)"
  ></app-aviso>
}